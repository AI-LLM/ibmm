<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ibmm · PyScript + Mermaid</title>
  <style>
    body { margin:0; font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
    header { padding:10px 14px; background:#0f172a; color:#e2e8f0; display:flex; gap:12px; align-items:center; }
    header b { color:#fff; }
    main { padding:16px; }
    .button-group { margin-bottom:16px; display:flex; gap:8px; }
    .button-group button { padding:8px 16px; border-radius:6px; border:1px solid #e5e7eb; background:#f9fafb; cursor:pointer; font-weight:500; }
    .button-group button.active { background:#0f172a; color:#fff; border-color:#0f172a; }
    #mermaid { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; overflow:auto; }
    #error  { background:#111827; color:#fca5a5; border-radius:12px; padding:16px; overflow:auto; display:none; white-space:pre; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad:false, securityLevel:'loose' });</script>

  <!-- PyScript core（用最新稳定版即可；如需固定版本可把 latest 换成具体号） -->
  <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
  <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>

  <!-- 把本地 .py 文件放进 PyScript 的虚拟文件系统，便于 import -->
  <py-config>
    packages = []  # 需要装第三方纯 Python 包时加 ["micropip", ...]
    [[fetch]]
    files = [
      "ibmm/__init__.py", "ibmm/core.py", "ibmm/ibis.py",
      "graphs/__init__.py", "graphs/example_mixed.py"
    ]
  </py-config>
</head>
<body>
  <header><b>IBMM</b><span>&nbsp;· Issue-Based Mind Map preview</span></header>
  <main>
    <div class="button-group">
      <button id="chart-btn" class="active">Flowchart</button>
      <button id="mindmap-btn">Mindmap</button>
      <div style="display: flex; align-items: center; gap: 8px; margin-left: 16px;">
        <label for="subgraph-selector" style="color: #4b5563; font-weight: 500;">Subgraphs:</label>
        <select id="subgraph-selector" multiple style="width: 250px; border-radius: 6px; border: 1px solid #d1d5db; padding: 4px;"></select>
      </div>
    </div>
    <div id="mermaid">Loading…</div>
    <pre id="error"></pre>
  </main>

  <script type="py">
from js import document, window, mermaid, EventSource
from pyodide.ffi import create_proxy
import importlib, sys, traceback

def show_error():
    el = document.getElementById("error")
    el.textContent = traceback.format_exc()
    el.style.display = "block"
    document.getElementById("mermaid").textContent = ""
    print(traceback.format_exc(),file=sys.stderr)

# --- Globals ---
current_view = "flowchart"
ALL_NODE_CLASSES = []
CLASS_MAP = {}
# ---------------

def render_mermaid_diagram(mmd_code):
    """渲染 Mermaid 图表"""
    box = document.getElementById("mermaid")
    box.innerHTML = f'<pre class="mermaid">{mmd_code}</pre>'
    mermaid.run()
    document.getElementById("error").style.display = "none"

def render_flowchart(graph_mod: str):
    try:
        import ibmm

        # 从下拉框读取 subgraphs
        selector = document.getElementById("subgraph-selector")
        selected_options = [opt.value for opt in selector.selectedOptions]
        subgraph_objects = [CLASS_MAP[name] for name in selected_options if name in CLASS_MAP]

        node_styles = {
            "issue":    "fill:#fff2cc,stroke:#cc7a00,stroke-width:1.5px;",
            "position": "fill:#eafff5,stroke:#148f55,stroke-width:1.5px;",
            "pro":      "fill:#f0fff4,stroke:#22c55e,stroke-width:1px;",
            "con":      "fill:#fff1f2,stroke:#ef4444,stroke-width:1px;",
        }

        edge_styles = {
            "supports": "stroke:green,stroke-width:2px;",
            "opposes":  "stroke:red,stroke-width:2px;",
            "answers":  "stroke:blue,stroke-width:1.5px,stroke-dasharray: 4 2;",
            "relates":  "stroke:#6b7280,stroke-dasharray: 2 2;",
        }

        mmd = ibmm.to_mermaid_flowchart(
            root=None,
            include=("contains","answers","supports","opposes","relates"),
            show_text=True,
            node_styles=node_styles,
            edge_styles=edge_styles,
            subgraphs=subgraph_objects
        )
        render_mermaid_diagram(mmd)
    except Exception:
        show_error()

def render_mindmap(graph_mod: str):
    try:
        import ibmm
        mmd = ibmm.to_mermaid_mindmap(root=None)
        render_mermaid_diagram(mmd)
    except Exception:
        show_error()

def render(graph_mod: str):
    if current_view == "flowchart":
        render_flowchart(graph_mod)
    else:
        render_mindmap(graph_mod)

# --- 初始化和事件处理 ---

# 从 URL 获取 graph 模块名
qs = window.location.search or ""
params = {}
if qs.startswith("?"):
    for part in qs[1:].split("&"):
        if "=" in part:
            k,v = part.split("=",1); params[k]=v
graph = params.get("graph") or "graphs.example_mixed"
if graph.endswith(".py"): graph = graph[:-3].replace("/", ".")

# 填充 subgraph 选择器
def populate_selector():
    global ALL_NODE_CLASSES, CLASS_MAP
    try:
        import ibmm
        ALL_NODE_CLASSES = ibmm.to_node_classes()
        print("DEBUG: Classes from to_node_classes():", ALL_NODE_CLASSES)
        CLASS_MAP = {c.__qualname__: c for c in ALL_NODE_CLASSES}

        selector = document.getElementById("subgraph-selector")
        selector.innerHTML = ""

        for name in sorted(CLASS_MAP.keys()):
            option = document.createElement("option")
            option.value = name
            option.textContent = name
            selector.appendChild(option)
    except Exception:
        show_error()

# 设置按钮激活状态
def set_active_button(active_id):
    document.getElementById("chart-btn").classList.remove("active")
    document.getElementById("mindmap-btn").classList.remove("active")
    document.getElementById(active_id).classList.add("active")

# 定义事件回调
def on_chart_click(event):
    global current_view
    current_view = "flowchart"
    set_active_button("chart-btn")
    render(graph)

def on_mindmap_click(event):
    global current_view
    current_view = "mindmap"
    set_active_button("mindmap-btn")
    render(graph)

def on_selection_change(event):
    if current_view == "flowchart":
        render_flowchart(graph)

# 创建 PyScript 代理
chart_click_proxy = create_proxy(on_chart_click)
mindmap_click_proxy = create_proxy(on_mindmap_click)
selection_proxy = create_proxy(on_selection_change)

# 绑定事件监听器
document.getElementById("chart-btn").addEventListener("click", chart_click_proxy)
document.getElementById("mindmap-btn").addEventListener("click", mindmap_click_proxy)
document.getElementById("subgraph-selector").addEventListener("change", selection_proxy)

# --- 页面加载后的初始执行流程 ---
try:
    # 1. 导入 graph 模块以注册所有节点
    importlib.invalidate_caches()
    importlib.import_module(graph)

    # 2. 填充选择器
    populate_selector()

    # 3. 渲染初始视图
    render(graph)
except Exception:
    show_error()

# 可选：SSE 热刷新
try:
    es = EventSource.new("/events")
    es.onmessage = lambda ev: window.location.reload()
except Exception:
    pass
  </script>
</body>
</html>
