<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ibmm · PyScript + Mermaid</title>
  <style>
    body { margin:0; font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
    header { padding:10px 14px; background:#0f172a; color:#e2e8f0; display:flex; gap:12px; align-items:center; }
    header b { color:#fff; }
    main { padding:16px; }
    .button-group { margin-bottom:16px; display:flex; gap:8px; align-items:center; }
    .button-group button { padding:8px 16px; border-radius:6px; border:1px solid #e5e7eb; background:#f9fafb; cursor:pointer; font-weight:500; }
    .button-group button.active { background:#0f172a; color:#fff; border-color:#0f172a; }
    #mermaid { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; overflow:auto; }
    #error  { background:#111827; color:#fca5a5; border-radius:12px; padding:16px; overflow:auto; display:none; white-space:pre; }

    /* New styles for tag-based multi-select */
    #subgraph-input-container {
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 4px;
      margin-left: 16px;
    }
    #tag-container {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .tag {
      display: flex;
      align-items: center;
      background-color: #e5e7eb;
      color: #1f2937;
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 13px;
      white-space: nowrap;
    }
    .tag .close-btn {
      margin-left: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    #subgraph-adder {
      border: none;
      outline: none;
      background: transparent;
      padding: 4px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad:false, securityLevel:'loose' });</script>

  <!-- PyScript core -->
  <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
  <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>

  <!-- PyScript config -->
  <py-config>
    packages = []
    [[fetch]]
    files = [
      "ibmm/__init__.py", "ibmm/core.py", "ibmm/ibis.py",
      "graphs/__init__.py"
    ]
  </py-config>
  <script>
    // Get graph parameter from URL
    function getGraphFromUrl() {
      const qs = window.location.search || "";
      const params = {};
      if (qs.startsWith("?")) {
        for (const part of qs.substring(1).split("&")) {
          if (part.includes("=")) {
            const [k, v] = part.split("=", 2);
            params[k] = v;
          }
        }
      }
      let graph = params.graph || "graphs.example_mixed";
      if (graph.endsWith(".py")) graph = graph.slice(0, -3).replace("/", ".");
      const graphPath = graph.replace(".", "/") + ".py";
      return { graph, graphPath };
    }

    const { graph, graphPath } = getGraphFromUrl();
  </script>
</head>
<body>
  <header><b>IBMM</b><span>&nbsp;· Issue-Based Mind Map preview</span></header>
  <main>
    <div class="button-group">
      <button id="chart-btn" class="active">Flowchart</button>
      <button id="mindmap-btn">Mindmap</button>
      <!-- New tag-based multi-select input -->
      <div id="subgraph-input-container">
        <div id="tag-container"></div>
        <select id="subgraph-adder"></select>
      </div>
    </div>
    <div id="mermaid">Loading…</div>
    <pre id="error"></pre>
  </main>

  <script type="py">
from js import document, window, mermaid, EventSource, Object
from pyodide.ffi import create_proxy, to_js
import importlib, sys, traceback, pyscript

def show_error():
    el = document.getElementById("error")
    el.textContent = traceback.format_exc()
    el.style.display = "block"
    document.getElementById("mermaid").textContent = ""
    print(traceback.format_exc(),file=sys.stderr)

# --- Globals ---
current_view = "flowchart"
CLASS_MAP = {}

# --- Python functions exposed to JavaScript ---

def get_node_classes_and_map():
    """Called from JS to get all node classes and a map to them."""
    global CLASS_MAP
    import ibmm
    node_classes = ibmm.to_node_classes()
    CLASS_MAP = {c.__qualname__: c for c in node_classes}
    # Return a JS-friendly array of names
    return to_js(sorted(list(CLASS_MAP.keys())))

def render_flowchart_js(graph_mod: str, selected_subgraphs: Object):
    """JS-callable version of render_flowchart."""
    try:
        import ibmm
        # Convert JS array of names to Python list
        selected_names = selected_subgraphs.to_py()
        subgraph_objects = [CLASS_MAP[name] for name in selected_names if name in CLASS_MAP]

        node_styles = {
            "issue":    "fill:#fff2cc,stroke:#cc7a00,stroke-width:1.5px;",
            "position": "fill:#eafff5,stroke:#148f55,stroke-width:1.5px;",
            "pro":      "fill:#f0fff4,stroke:#22c55e,stroke-width:1px;",
            "con":      "fill:#fff1f2,stroke:#ef4444,stroke-width:1px;",
        }
        edge_styles = {
            "supports": "color:green,stroke:green,stroke-width:2px;",
            "opposes":  "color:red,stroke:red,stroke-width:2px;",
            "answers":  "color:blue,stroke:blue,stroke-width:2px;",
            "relates":  "color:gray,stroke:gray,stroke-dasharray: 2 2;",
        }

        mmd = ibmm.to_mermaid_flowchart(
            root=None,
            include=("contains","answers","supports","opposes","relates"),
            show_text=True,
            node_styles=node_styles,
            edge_styles=edge_styles,
            subgraphs=subgraph_objects
        )
        render_mermaid_diagram(mmd)
    except Exception:
        show_error()

def render_mindmap(graph_mod: str):
    try:
        import ibmm
        mmd = ibmm.to_mermaid_mindmap(root=None)
        render_mermaid_diagram(mmd)
    except Exception:
        show_error()

def render_mermaid_diagram(mmd_code):
    box = document.getElementById("mermaid")
    box.innerHTML = f'<pre class="mermaid">{mmd_code}</pre>'
    mermaid.run()
    document.getElementById("error").style.display = "none"

# --- Initial page setup (called from JS) ---
def initial_setup(graph:str, graph_path: str, content: str):
    # Write content to the graph_path file
    from pathlib import Path
    import os

    # Ensure directory exists
    file_path = Path(graph_path)
    os.makedirs(file_path.parent, exist_ok=True)

    # Write content to file
    with open(graph_path, 'w') as f:
        f.write(content)

    try:
        importlib.invalidate_caches()
        importlib.import_module(graph)
        return graph
    except Exception:
        show_error()
        return None

# --- Expose Python functions to JavaScript ---
window.pyInitialSetup = pyscript.ffi.create_proxy(initial_setup)
window.pyGetNodeClasses = pyscript.ffi.create_proxy(get_node_classes_and_map)
window.pyRenderFlowchart = pyscript.ffi.create_proxy(render_flowchart_js)
window.pyRenderMindmap = pyscript.ffi.create_proxy(render_mindmap)

  </script>

  <script>
    // --- Pure JavaScript for UI interaction ---
    function initializeApp() {
      // --- State ---
      let current_view = "flowchart";
      let allOptions = [];
      let selectedOptions = [];
      let graph_mod = null;

      // --- DOM Elements ---
      const tagContainer = document.getElementById("tag-container");
      const subgraphAdder = document.getElementById("subgraph-adder");
      const chartBtn = document.getElementById("chart-btn");
      const mindmapBtn = document.getElementById("mindmap-btn");

      // --- Functions ---
      function renderUI() {
        // 1. Render tags
        tagContainer.innerHTML = "";
        for (const option of selectedOptions) {
          const tag = document.createElement("div");
          tag.className = "tag";
          tag.dataset.name = option;
          const text = document.createElement("span");
          text.textContent = option;
          const closeBtn = document.createElement("span");
          closeBtn.className = "close-btn";
          closeBtn.textContent = "×";
          closeBtn.addEventListener("click", () => removeTag(option));
          tag.appendChild(text);
          tag.appendChild(closeBtn);
          tagContainer.appendChild(tag);
        }

        // 2. Render dropdown
        subgraphAdder.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.textContent = "Add subgraph...";
        placeholder.value = "";
        placeholder.disabled = true;
        placeholder.selected = true;
        subgraphAdder.appendChild(placeholder);

        const availableOptions = allOptions.filter(o => !selectedOptions.includes(o));
        for (const option of availableOptions) {
          const optEl = document.createElement("option");
          optEl.value = option;
          optEl.textContent = option;
          subgraphAdder.appendChild(optEl);
        }
      }

      function redrawFlowchart() {
        if (current_view === "flowchart") {
          window.pyRenderFlowchart(graph_mod, selectedOptions);
        }
      }

      function addTag(name) {
        if (name && !selectedOptions.includes(name)) {
          selectedOptions.push(name);
          renderUI();
          redrawFlowchart();
        }
      }

      function removeTag(name) {
        selectedOptions = selectedOptions.filter(o => o !== name);
        renderUI();
        redrawFlowchart();
      }

      // --- Event Listeners ---
      subgraphAdder.addEventListener("change", (e) => {
        addTag(e.target.value);
        // Reset dropdown to placeholder
        e.target.value = "";
      });

      chartBtn.addEventListener("click", () => {
        current_view = "flowchart";
        chartBtn.classList.add("active");
        mindmapBtn.classList.remove("active");
        document.getElementById('subgraph-input-container').style.display = 'flex';
        redrawFlowchart();
      });

      mindmapBtn.addEventListener("click", () => {
        current_view = "mindmap";
        chartBtn.classList.remove("active");
        mindmapBtn.classList.add("active");
        document.getElementById('subgraph-input-container').style.display = 'none';
        window.pyRenderMindmap(graph_mod);
      });

      // Load graph content from file
      async function loadGraphContent() {
        try {
          const response = await fetch(`${graphPath}?t=${Date.now()}`);
          if (!response.ok) {
            throw new Error(`Failed to load ${graphPath}: ${response.status} ${response.statusText}`);
          }
          const graphContent = await response.text();
          console.log(`Loaded graph from ${graphPath}`);
          return graphContent;
        } catch (error) {
          console.error("Error loading graph content:", error);
          document.getElementById("error").textContent = `Error loading ${graphPath}: ${error.message}`;
          document.getElementById("error").style.display = "block";
          return null;
        }
      }

      // Initialize graph content
      loadGraphContent().then(content => {
        if (content) {
          console.log("Graph content loaded successfully");
          // You can add additional processing of the content here if needed
      // --- Initialization ---
      graph_mod = window.pyInitialSetup(graph, graphPath, content);
      if (graph_mod) {
        allOptions = window.pyGetNodeClasses();
        renderUI();
        // Initial render
        if (current_view === 'flowchart') redrawFlowchart();
        else window.pyRenderMindmap(graph_mod);
      }

        }//loadGraphContent
      });

      // Optional: SSE Hot Reload
      try {
        const es = new EventSource("/events");
        es.onmessage = (ev) => window.location.reload();
      } catch (e) {}
    }

    // Listen for the official PyScript event that fires after our code has run
    addEventListener("py:done", initializeApp);
  </script>
</body>
</html>
